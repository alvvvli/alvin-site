<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Shinkansen Shuffle â€” Debug Build</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f172a; --rail:#1b2437; --ink:#e6eef9; --muted:#9fb4d1;
    --accent:#60a5fa; --line:#1f2a44; --faint:rgba(255,255,255,.06);
    --train-w:160px; --board-min:520px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Ubuntu,sans-serif;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  h1{margin:6px 0 14px;font-size:22px}

  .hud{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:8px 0 14px}
  .hud .card{background:var(--panel);padding:10px 14px;border-radius:14px;box-shadow:0 4px 24px rgba(0,0,0,.35);border:1px solid var(--line);min-width:86px;text-align:center}
  .hud strong{display:block;font-size:18px}
  .btn{appearance:none;border:none;background:var(--accent);color:#081016;font-weight:700;padding:12px 16px;border-radius:16px;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--ink);border:1px solid var(--line)}

  .board{position:relative;background:linear-gradient(180deg,var(--panel),#0b121d);border:1px solid var(--line);border-radius:16px;overflow:hidden;min-height:var(--board-min)}
  .sky{position:absolute;inset:0;background:radial-gradient(1000px 300px at 70% 0%,rgba(96,165,250,.15),transparent); z-index:0;}
  .lanes{position:absolute;inset:72px 0 0 0;display:grid;grid-template-columns:repeat(5,1fr);height:calc(100% - 72px); z-index:1;}
  .platform{position:relative;border-left:1px solid var(--faint)}
  .platform:first-child{border-left:none}
  .platform::before{content:"";position:absolute;left:0;right:0;top:44px;height:4px;background:repeating-linear-gradient(90deg,var(--rail) 0 16px,transparent 16px 24px)}
  .platform .label{position:absolute;top:10px;left:10px;font:600 13px/1 system-ui;opacity:.8}
  .platform .target{position:absolute;left:6px;right:6px;bottom:10px;height:96px;border:1px dashed rgba(150,170,200,.35);border-radius:12px;display:flex;align-items:center;justify-content:center;color:var(--muted);background: rgba(255,255,255,.02)}

  .train{position:absolute;top:96px;width:var(--train-w);height:48px;border-radius:40px;background:#e8f2ff;color:#0b0f14;box-shadow:0 8px 24px rgba(0,0,0,.35);border:2px solid rgba(0,0,0,.08);display:flex;align-items:center;gap:10px;padding:0 12px;cursor:grab;touch-action:none; z-index:2;}
  .nose{width:16px;height:16px;border-radius:50%;background:currentColor;opacity:.9}
  .cars{display:flex;gap:4px;margin-left:auto}
  .car{width:14px;height:10px;border-radius:2px;background:rgba(0,0,0,.35)}
  .badge{font-size:12px;padding:3px 9px;border-radius:999px;color:#091018;background:var(--accent);font-weight:700}

  /* simple liveries */
  .livery-e5{background:linear-gradient( to bottom, #00a489 0 50%, #e8f2ff 50% 100%),linear-gradient( to right, transparent 0 16%, #ff5fa2 16% 24%, transparent 24% 100%)}
  .livery-h5{background:linear-gradient( to bottom, #00a489 0 50%, #e8f2ff 50% 100%),linear-gradient( to right, transparent 0 16%, #8a63d2 16% 24%, transparent 24% 100%)}
  .livery-e6{background:linear-gradient( to bottom, #b4002d 0 38%, #e8f2ff 38% 100%),linear-gradient( to right, transparent 0 18%, #c0c6cf 18% 24%, transparent 24% 100%)}
  .livery-e7{background:linear-gradient( to bottom, #6ba5ff 0 34%, #efe9db 34% 100%),linear-gradient( to right, transparent 0 18%, #b87333 18% 21%, #6ba5ff 21% 24%, transparent 24% 100%)}
  .livery-n700s{background:linear-gradient( to bottom, #f6fbff 0 100%),linear-gradient( to right, transparent 0 18%, #2456ff 18% 24%, transparent 24% 100%)}
  .livery-800{background:linear-gradient( to bottom, #ffffff 0 100%),linear-gradient( to right, transparent 0 18%, #d12b2b 18% 24%, transparent 24% 100%)}
</style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸš„ Shinkansen Shuffle</h1>

    <div class="hud">
      <div class="card">Score <strong id="score">0</strong></div>
      <div class="card">Time <strong id="time">60</strong>s</div>
      <div class="card">Combo <strong id="combo">x1</strong></div>
      <button class="btn" id="playBtn">Start</button>
    </div>

    <div class="board" id="board">
      <div class="sky"></div>
      <div class="lanes" id="lanes"></div>
      <div id="debug" style="position:absolute;right:8px;top:8px;font:12px/1 system-ui;color:#9fb4d1;background:#0b111c;border:1px solid #1f2a44;border-radius:8px;padding:6px 8px;z-index:5;opacity:.9"></div>
    </div>
  </div>

<script>
(function(){
  // -------- Config
  const AUTO_START = true;
  const DROP_BUFFER_X_PCT = 0.35;
  const DROP_BUFFER_Y = 36;
  const PLATFORM_COUNT = 5;
  const SPAWN_MS_MIN = 1100, SPAWN_MS_MAX = 1900;
  const TRAIN_SPEED = 0.18; // px/ms

  // -------- Elements
  const lanesEl = document.getElementById('lanes');
  const board   = document.getElementById('board');
  const scoreEl = document.getElementById('score');
  const timeEl  = document.getElementById('time');
  const comboEl = document.getElementById('combo');
  const playBtn = document.getElementById('playBtn');
  const dbg     = document.getElementById('debug');

  // -------- State
  let running=false, score=0, timeLeft=60, combo=1, tickTimer=null, spawnTimer=null;
  const trains = new Set();

  // -------- Utils
  const THEMES=['theme-blue','theme-green','theme-yellow','theme-purple','theme-red'];
  const MODELS = [
    {code:'E5', livery:'livery-e5'},
    {code:'H5', livery:'livery-h5'},
    {code:'E6', livery:'livery-e6'},
    {code:'E7', livery:'livery-e7'},
    {code:'W7', livery:'livery-e7'},
    {code:'N700S', livery:'livery-n700s'},
    {code:'800', livery:'livery-800'}
  ];
  const rand=a=>a[Math.floor(Math.random()*a.length)];
  const between=(a,b)=>a+Math.random()*(b-a);
  const rect = el => el.getBoundingClientRect();

  function log(s){ dbg.textContent = s; console.log(s); }

  // -------- Build lanes
  function initBoard(){
    lanesEl.innerHTML='';
    for(let i=1;i<=PLATFORM_COUNT;i++){
      const p=document.createElement('div'); p.className='platform'; p.dataset.id=i;
      const lab=document.createElement('div'); lab.className='label'; lab.textContent='Platform '+i;
      const t=document.createElement('div'); t.className='target'; t.textContent='Drop Here'; t.dataset.id=i;
      p.append(lab,t); lanesEl.appendChild(p);
    }
    log('board: '+board.clientWidth+'Ã—'+board.clientHeight);
  }

  function showToast(msg){ log(msg); }

  // -------- Game flow
  function startGame(){
    if(running) return;
    running=true; score=0; timeLeft=60; combo=1;
    trains.forEach(killTrain); trains.clear();
    scoreEl.textContent=score; timeEl.textContent=timeLeft; comboEl.textContent='x'+combo;

    tickTimer = setInterval(()=>{
      timeLeft--; timeEl.textContent=timeLeft; 
      if(timeLeft<=0) endGame();
    }, 1000);

    spawnTrain();
    scheduleSpawn();
    showToast('Dispatch started');
  }

  function endGame(){
    running=false; clearInterval(tickTimer); clearTimeout(spawnTimer);
    trains.forEach(killTrain); trains.clear();
    showToast('Game ended');
    playBtn.textContent='Play Again';
  }

  function scheduleSpawn(){
    if(!running) return;
    spawnTimer = setTimeout(()=>{ spawnTrain(); scheduleSpawn(); }, between(SPAWN_MS_MIN, SPAWN_MS_MAX));
  }

  // -------- Spawning (robust to zero-size iframe layout)
  function spawnTrain(){
    if (!board.clientWidth || !board.clientHeight){
      requestAnimationFrame(spawnTrain);
      return;
    }

    const platform = Math.ceil(Math.random()*PLATFORM_COUNT);
    const model = rand(MODELS);

    const usable = Math.max(200, board.clientHeight - 210);
    const y = 96 + Math.floor(Math.random() * usable);

    const el = document.createElement('div');
    el.className = `train ${model.livery}`;
    el.style.top  = y + 'px';
    const startX = Math.max(10, board.clientWidth - 140);
    el.style.left = startX + 'px';

    el.dataset.target = String(platform);
    el.dataset.vx     = String(-between(0.12, TRAIN_SPEED));

    el.innerHTML = `<span class="badge">P${platform}</span><span class="nose"></span><div class="cars">${'<div class="car"></div>'.repeat(6)}</div>`;

    board.appendChild(el);
    const obj = {el, grabbed:false, x:startX, y, vx: parseFloat(el.dataset.vx)};
    trains.add(obj);

    log(`spawn â†’ P${platform} ${model.code} @ x=${obj.x.toFixed(1)} vx=${obj.vx.toFixed(3)} trains=${trains.size}`);

    el.addEventListener('pointerdown', e=>{
      obj.grabbed=true; el.setPointerCapture(e.pointerId);
      obj.offsetX = e.clientX - obj.x; obj.offsetY = e.clientY - obj.y;
    });
    el.addEventListener('pointermove', e=>{
      if(!obj.grabbed) return;
      obj.x = e.clientX - obj.offsetX; obj.y = e.clientY - obj.offsetY;
      updateTrain(obj);
    });
    el.addEventListener('pointerup', ()=>{ obj.grabbed=false; /* drop check omitted for debug build */ });
  }

  function killTrain(t){ if(!t || !t.el) return; t.el.remove(); }
  function updateTrain(t){ if(!t.el) return; t.el.style.left = t.x+'px'; t.el.style.top = t.y+'px'; }

  // -------- Loop
  let last = performance.now();
  function gameLoop(now){
    const dt = now - last; last = now;
    if(running){
      trains.forEach(t=>{
        if(!t.grabbed){ t.x += t.vx * dt; updateTrain(t); }
        if(t.x < -300){ t.el.remove(); trains.delete(t); log('miss â†’ trains='+trains.size); }
      });
    }
    requestAnimationFrame(gameLoop);
  }

  // -------- Wire + Boot
  playBtn.addEventListener('click', startGame);
  initBoard();
  requestAnimationFrame(gameLoop);
  if (AUTO_START) startGame();

  // Safety: after 1500 ms, if no trains, force one
  setTimeout(()=>{ if(trains.size===0){ log('force spawn'); spawnTrain(); } }, 1500);
})();
</script>
</body>
</html>
